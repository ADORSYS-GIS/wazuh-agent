name: Release

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - develop

jobs:
  test-install-script:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        if [[ "${{ matrix.os }}" == "ubuntu-latest" ]]; then
          sudo apt update
          sudo apt install -y bats curl jq sed
        elif [[ "${{ matrix.os }}" == "macos-latest" ]]; then
          brew install bats coreutils curl jq gnu-sed docker
        fi

    - name: Make script executable
      run: chmod +x ./scripts/install.sh
      
    - name: Install wazuh-agent
      run: |
        sudo ./scripts/install.sh
  test-setup-agent-script:
    runs-on: ${{ matrix.os }}
    needs: test-install-script
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        if [[ "${{ matrix.os }}" == "ubuntu-latest" ]]; then
          sudo apt update
          sudo apt install -y bats curl jq sed
        elif [[ "${{ matrix.os }}" == "macos-latest" ]]; then
          brew install bats coreutils curl jq gnu-sed docker
        fi

    - name: Make script executable
      run: chmod +x ./scripts/setup-agent.sh
      
    - name: Launch setup-agent script
      run: |
        sudo ./scripts/setup-agent.sh
  build-windows-installer:
    name: Build Windows Installer
    runs-on: windows-latest
    needs: test-setup-agent-script
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install PS2EXE
      shell: powershell
      run: |
        Install-Module -Name ps2exe -Force -Scope CurrentUser
        Import-Module ps2exe

    - name: Get version from tag or commit
      id: get_version
      shell: bash
      run: |
        if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
          FULL_VERSION=${GITHUB_REF#refs/tags/v}
          # Strip pre-release tags and build metadata for PS2EXE (only accepts n.n.n.n format)
          EXE_VERSION=$(echo "$FULL_VERSION" | sed -E 's/(-rc\.[0-9]+|-alpha\.[0-9]+|-beta\.[0-9]+|\+.*)$//')
        else
          FULL_VERSION="0.1.0-dev+${GITHUB_SHA::7}"
          EXE_VERSION="0.1.0"
        fi
        echo "VERSION=$FULL_VERSION" >> $GITHUB_OUTPUT
        echo "EXE_VERSION=$EXE_VERSION" >> $GITHUB_OUTPUT
        echo "Full version: $FULL_VERSION"
        echo "Executable version: $EXE_VERSION"

    - name: Build executable with PS2EXE
      shell: powershell
      run: |
        $exeVersion = "${{ steps.get_version.outputs.EXE_VERSION }}"
        $fullVersion = "${{ steps.get_version.outputs.VERSION }}"

        Write-Host "Building executable with version: $exeVersion (Full: $fullVersion)"

        Invoke-PS2EXE -inputFile ".\scripts\setup-agent.ps1" `
                      -outputFile ".\scripts\wazuh-setup-agent-windows-x64.exe" `
                      -title "Wazuh Agent Installer" `
                      -company "adorsys" `
                      -version $exeVersion `
                      -copyright "Copyright 2025" `
                      -requireAdmin `
                      -noConsole

    - name: Verify executable
      shell: powershell
      run: |
        if (Test-Path ".\scripts\wazuh-setup-agent-windows-x64.exe") {
          Write-Host "Executable created successfully"
          $fileInfo = Get-Item ".\scripts\wazuh-setup-agent-windows-x64.exe"
          Write-Host "File size: $($fileInfo.Length) bytes"
          Write-Host "Created: $($fileInfo.CreationTime)"
        } else {
          Write-Error 'Failed to create executable'
          exit 1
        }

    - name: Upload executable as artifact
      uses: actions/upload-artifact@v4
      with:
        name: wazuh-setup-agent-windows-x64-${{ steps.get_version.outputs.VERSION }}
        path: scripts/wazuh-setup-agent-windows-x64.exe
        retention-days: 90

    - name: Create Release with Windows Installer
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: Release ${{ steps.get_version.outputs.VERSION }}
        files: scripts/wazuh-setup-agent-windows-x64.exe
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}